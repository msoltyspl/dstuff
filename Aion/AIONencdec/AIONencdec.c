#include <stdio.h>
#include <errno.h>
#include <getopt.h>
#include <string.h>

#include "bfile.h"
#include "pooler.h"
#include "zip.h"
#include "version.h"

#define EXCEPT goto l_finalize
#define EXCEPT_LABEL l_finalize:

#define MIN(a,b) ((a)<(b)?(a):(b))
#define MAX(a,b) ((a)>(b)?(a):(b))


#define CHUNK (2*1048576)
#define READSHIFT(fin,off,siz) if(bfread(fin,off,siz) != siz) EXCEPT; off += siz;
#define FLUSH(fout,off,siz) if(bfwrite(fout,off,siz) != siz) EXCEPT;

//close
uint32_t g_xortab1[] = {
	0xF7515D2F, 0x93B4E901, 0x3E81514E, 0x99DF3FAF, 0x83135E80, 0xB557469B, 0xB1EC5C1B, 0x31A97C29, 
	0xA7DAE568, 0x16AE4FF6, 0xCF037F9A, 0x51D05E1D, 0xD902E55A, 0xF4FBD011, 0x88A27CF8, 0xA21FD826, 
	0xA933DA43, 0x0D5A4EAC, 0x2D8678ED, 0x9BC46AB2, 0x578577AA, 0x35D8A66A, 0x176B97D8, 0x1D7AB724, 
	0x799E3BD3, 0x019FAEF2, 0x40299DE6, 0x169C2FED, 0x99D118DA, 0x630AD40E, 0xEBD7922D, 0x2150A7B4, 
	0xD6450FD8, 0x47CCBFC6, 0x3EED59CC, 0x26A0FE71, 0x8507D1FC, 0x3612EE8A, 0xE1605A11, 0xF79EBD8F, 
	0xCD3964B6, 0xF79A5A49, 0xA2C11C90, 0xF781B30B, 0x4B2AB8CA, 0x2EDC1395, 0x1664E54A, 0xB1C99994, 
	0xAE76537B, 0xF726DFC4, 0x31785FC8, 0x7F5AAFAE, 0x5E29E7A4, 0x91BBE20E, 0xF02C3241, 0x279E60CE, 
	0x13DCFADC, 0xF1F737AC, 0xF4CDA4B4, 0x7BA9DC7A, 0x7DDA8295, 0x6E6B8DFB, 0x23E7430C, 0xF953C06C, 
	0xDE388239, 0x57FED09B, 0x4365753D, 0x6E5AAEB0, 0xAEFBB34E, 0x9B0FC48C, 0xA2AF2765, 0x9184F1C6, 
	0x39391A94, 0x6490A553, 0xB5CC62F0, 0xA7BC1EBF, 0x3F33AE28, 0xB730C616, 0xB183F2B1, 0x2037B05E, 
	0x957BF79D, 0x1B6E35BE, 0x32770507, 0x398AAE3A, 0xC510AF25, 0x2BC25618, 0xD64BC4F9, 0x9DD744DC, 
	0xAD7F5CA8, 0x46BC88EF, 0xE3C0FE5F, 0x03E369DE, 0x1F06F8ED, 0x2322C138, 0xE1D7C1F4, 0xCB3C7B11, 
	0x82AF8DB4, 0x780D3023, 0x3EEDF982, 0xA752E191, 0x7175D5D5, 0x9711DA46, 0xEADF16FB, 0x32A0ABF3, 
	0x5E5EDB66, 0x0E5543B9, 0xFD2AA59E, 0x93C6315E, 0x2BA29AD4, 0x46B90037, 0x5105F713, 0x22AAB2A7, 
	0xD2C59D0C, 0x28F4623D, 0x2589BC8C, 0xFD9AFA79, 0x02BCA18D, 0xB6B0152B, 0xBCCDA4E6, 0xB468F872, 
	0xBA08339A, 0xB1B1B762, 0x010800CA, 0xE18E6840, 0xF2D84F49, 0x37F08567, 0x1EAB61C9, 0xCA4D6AC6, 
	0x362F03AF, 0x5EBCF002, 0x258A3981, 0x04CA2C38, 0x44F60DF9, 0xDEDB465B, 0xACF47BB7, 0x0D367F3B, 
	0xB02C7C90, 0xA9AB4820, 0x6DDB397F, 0xF1E2800B, 0x83FA5037, 0x8C3ED39D, 0xE7EB4854, 0xEB6A3492, 
	0xDADA182B, 0xD37E7CE5, 0xFDB1D93D, 0x00CD2890, 0x86B39345, 0xE64B32EB, 0x97B624EA, 0xA09411B4, 
	0xAEFB5316, 0xE99AD7A6, 0x41A6FBD9, 0x4BEC6DC2, 0x6CD7590B, 0x5D9BEC2E, 0xCB66766F, 0x2CCA23B0, 
	0x6E3AB68D, 0xBDD129DC, 0xEB3F891D, 0xB80922C7, 0x98042E1D, 0x26351A71, 0xDBF2AA7D, 0x568A01C0, 
	0xA327D176, 0xEA58C82B, 0xF9E67276, 0xF454A0EA, 0xBBC0A4B2, 0x3F8154EC, 0x693C3758, 0xB1B7C845, 
	0x203D3B60, 0xD2CE975B, 0xAFF2B1FC, 0x7467CBA2, 0xC87958AD, 0x7154C1FE, 0x590B98EA, 0x94A021C6, 
	0xFDDE917F, 0xA13CFC61, 0x979F4771, 0x74430D89, 0xFE85EC97, 0x49E70D2E, 0xDD0E55CA, 0x22F838F4, 
	0x9E557EB1, 0x4A0FEA56, 0x860F3D3A, 0xF9515764, 0xE4230CA3, 0x20DF6A2A, 0x6DDDF831, 0x42DFC4A8, 
	0xACD2AE7D, 0x851FD77D, 0x974FA467, 0xD0612521, 0x47776BA9, 0x134797C7, 0xC8FA1A03, 0xA6D705E2, 
	0x1871DA0E, 0xD8AAC542, 0x2F5396B0, 0x8FAD78D3, 0x3B91C42B, 0x0990D707, 0xF7CC55CB, 0xC5CFBDCC, 
	0x1D34C13B, 0x8D593C35, 0xF7F73575, 0x90D6DBB7, 0x2066DB53, 0xB098F70E, 0x49A451BD, 0xE21D3FB4, 
	0x3C042B82, 0xB6394B13, 0xE700A8BD, 0xFAE56033, 0x9BD57BF1, 0x819F4C2B, 0x55B8B9B6, 0x057A5F16, 
	0x3EB3E607, 0x2FC38BBC, 0x39192337, 0xBA4CA2D1, 0x99A37881, 0xB953B0D3, 0xFC2B4438, 0xFE0F7B8F, 
	0x37FBCA99, 0x99D41D3E, 0x6FD5DD3C, 0x83E1C248, 0x527FAB23, 0x61C489A9, 0x6602AE6F, 0x67677AE9, 
	0x7F80B7AD, 0x61B5A8C8, 0x57B31AC9, 0xD3E96C73, 0x43FEFAA0, 0x4671C370, 0x022EBE2E, 0xA078CA17
};

//open
uint8_t g_xortab0[] = {
	0x86, 0xFA, 0x1A, 0x1C, 0x07, 0xBD, 0xD8, 0x64, 0xCE, 0xEE, 0x59, 0x88, 0xCD, 0xA9, 0x1D, 0x06, 
	0xF7, 0x3D, 0x31, 0x58, 0x83, 0xA1, 0x5C, 0x7E, 0xDF, 0xA6, 0x50, 0x9E, 0x89, 0xA8, 0x12, 0xD2, 
	0x25, 0x49, 0x75, 0xE2, 0x07, 0x0F, 0xEB, 0x01, 0x97, 0x4A, 0x66, 0x35, 0xAB, 0x32, 0x9D, 0xA7, 
	0x4E, 0xA2, 0x89, 0x62, 0x0F, 0x55, 0x41, 0xC5, 0x52, 0x10, 0x1F, 0x47, 0xB0, 0xA0, 0x63, 0xA6, 
	0xF0, 0x1C, 0x1C, 0x4C, 0x9B, 0x3C, 0xAC, 0xE2, 0xB3, 0x4E, 0x9F, 0xF1, 0xA4, 0x91, 0x29, 0x82, 
	0xE4, 0x76, 0x0D, 0x8D, 0x4F, 0xA3, 0x34, 0x4A, 0xCC, 0x1C, 0xC7, 0x18, 0x48, 0x8E, 0xFE, 0x18, 
	0x79, 0x08, 0x87, 0x28, 0x8E, 0x24, 0xB7, 0x6B, 0x38, 0xF2, 0x58, 0x01, 0x2D, 0xA8, 0x58, 0x0E, 
	0x9C, 0x54, 0x29, 0xCF, 0xA1, 0xAE, 0x0A, 0xD2, 0x3B, 0x4A, 0x10, 0xF8, 0xD8, 0x19, 0x31, 0x7D, 
	0xF3, 0xAE, 0x1B, 0x90, 0xD2, 0x2F, 0x16, 0xC7, 0xE5, 0x3B, 0xCC, 0xEF, 0xE1, 0xE1, 0x2C, 0x86, 
	0x00, 0xDD, 0x35, 0x67, 0x8D, 0x25, 0xFC, 0xED, 0x32, 0x1F, 0xA9, 0x1A, 0x12, 0x6D, 0xB0, 0xF7, 
	0x3D, 0xB6, 0x1F, 0xE8, 0x81, 0x4D, 0x36, 0xE7, 0x25, 0x30, 0x21, 0x90, 0x86, 0x30, 0x0E, 0xEE, 
	0x40, 0xBE, 0x6E, 0xDA, 0xC1, 0x3A, 0xAF, 0xF2, 0xEC, 0x28, 0x2C, 0xF1, 0xCD, 0x44, 0x98, 0x72, 
	0xDA, 0xCD, 0xC6, 0xD9, 0xDF, 0xF7, 0xEE, 0x88, 0x04, 0xE1, 0x62, 0x00, 0x08, 0x0E, 0xCD, 0x16, 
	0x37, 0xAB, 0xF9, 0xF5, 0x14, 0xAA, 0x2E, 0x00, 0x4E, 0xF8, 0x18, 0x41, 0x0B, 0xD9, 0x6F, 0x9B, 
	0xFA, 0xAD, 0x2B, 0x54, 0x56, 0x2E, 0x7F, 0x2C, 0x3B, 0x6A, 0x82, 0xA1, 0x7C, 0x7C, 0xA6, 0x8F, 
	0x66, 0x5E, 0xE7, 0xCF, 0x83, 0xB9, 0xEA, 0xFC, 0xE2, 0x31, 0xD4, 0x10, 0xF3, 0xF4, 0x22, 0xEC, 
	0x73, 0x14, 0x4F, 0x94, 0x78, 0x79, 0x8F, 0x1E, 0x29, 0xEA, 0x5F, 0x21, 0x1E, 0x08, 0x37, 0xB8, 
	0xF6, 0x9A, 0x2D, 0xC5, 0x36, 0x34, 0xC1, 0x97, 0xDC, 0x75, 0xB2, 0xAD, 0xD7, 0xE3, 0x04, 0xA7, 
	0xC0, 0xC9, 0x1C, 0x1A, 0x00, 0xE9, 0x2D, 0x6F, 0xD6, 0x8D, 0xBC, 0x73, 0x52, 0xC0, 0x8A, 0xB6, 
	0xBA, 0x2C, 0xA6, 0x7D, 0x7B, 0x6F, 0xF4, 0x47, 0x1A, 0x72, 0xE9, 0xB2, 0x30, 0x7D, 0xD4, 0xD3, 
	0x09, 0x9C, 0x65, 0xB0, 0xD0, 0x17, 0xCF, 0xFC, 0xF2, 0xFF, 0x46, 0xD2, 0xA6, 0x43, 0x11, 0x76, 
	0x2B, 0xE5, 0x1D, 0xE5, 0xC9, 0x47, 0x2F, 0x4B, 0x1B, 0xDD, 0x9A, 0xFD, 0x9D, 0x20, 0xB6, 0x43, 
	0x1A, 0x64, 0xE3, 0x68, 0xF3, 0x21, 0x57, 0x68, 0xD4, 0x04, 0x8F, 0xC3, 0xCE, 0xAF, 0xA3, 0xAB, 
	0x69, 0xA3, 0x3C, 0x34, 0xBE, 0x1F, 0x84, 0xA8, 0x0E, 0x74, 0xCB, 0xB7, 0xE6, 0xB1, 0x39, 0x8D, 
	0x68, 0x00, 0x3A, 0x9B, 0x9C, 0xB1, 0x09, 0x1C, 0x7D, 0x52, 0x15, 0x12, 0xA6, 0xB0, 0x83, 0xD3, 
	0x40, 0x47, 0x9B, 0xE4, 0x22, 0xE3, 0x6E, 0x30, 0xC4, 0xFC, 0x6F, 0x4F, 0xFE, 0x9F, 0x51, 0x14, 
	0x13, 0x57, 0xF1, 0xEB, 0x25, 0xF7, 0x95, 0x4C, 0x92, 0xB6, 0x3C, 0xD0, 0x34, 0x79, 0x59, 0x33, 
	0x20, 0xBE, 0xB8, 0xBF, 0xE0, 0x0A, 0xD2, 0x77, 0xBC, 0x43, 0x5C, 0x7D, 0xFC, 0xE1, 0x59, 0x00, 
	0xDE, 0x5A, 0x7D, 0x44, 0x11, 0xAC, 0x13, 0xF2, 0x64, 0x84, 0x4F, 0x5D, 0xA2, 0xC4, 0x36, 0xD7, 
	0x23, 0xFA, 0xF8, 0xD1, 0x14, 0x8D, 0xF9, 0xDD, 0x17, 0x1D, 0x52, 0x41, 0x22, 0xF5, 0x1A, 0x42, 
	0x39, 0xFE, 0x36, 0xD5, 0x0A, 0x10, 0x01, 0xD2, 0xEA, 0x12, 0x82, 0x5A, 0x48, 0xD2, 0x94, 0x95, 
	0x0A, 0xF7, 0xAB, 0x70, 0xF7, 0xF2, 0x98, 0x89, 0xA1, 0x68, 0xF9, 0xE1, 0xD6, 0xE1, 0xBD, 0x92, 
	0x38, 0x45, 0x5F, 0x19, 0xE2, 0xEA, 0x46, 0x76, 0xC5, 0xC3, 0xF2, 0xB4, 0x9F, 0x70, 0x53, 0x09, 
	0x3F, 0xB8, 0x06, 0x3A, 0xF3, 0x46, 0xC8, 0x6A, 0xCD, 0x0A, 0xE3, 0xF0, 0xAA, 0x34, 0xD9, 0x72, 
	0x98, 0x34, 0x23, 0xD1, 0x96, 0x8C, 0x32, 0x32, 0x3B, 0x00, 0xA3, 0x9E, 0x4F, 0xED, 0xBC, 0x97, 
	0xD4, 0x4A, 0x26, 0x15, 0x96, 0x1D, 0x0E, 0x36, 0xB8, 0xEE, 0x86, 0x45, 0x57, 0x04, 0x6D, 0x2B, 
	0xC0, 0xDB, 0x91, 0x0A, 0x46, 0xCE, 0x7C, 0x1F, 0x3C, 0x3A, 0x81, 0x94, 0x22, 0x26, 0x82, 0x6D, 
	0x83, 0xBD, 0x13, 0x2D, 0x96, 0x91, 0x53, 0x6C, 0x26, 0x0C, 0x44, 0xFE, 0xBD, 0xEE, 0xDA, 0xCC, 
	0xBD, 0x52, 0xA6, 0x11, 0x3E, 0x10, 0x42, 0x20, 0x60, 0xEB, 0x5F, 0x5B, 0x0D, 0x7C, 0xBB, 0x80, 
	0xAC, 0x2F, 0xB9, 0xF9, 0xD2, 0x4A, 0xEB, 0x54, 0x80, 0x60, 0x62, 0x85, 0xE5, 0x1A, 0xF0, 0x30, 
	0x45, 0xB7, 0x44, 0x82, 0xEF, 0x3A, 0x0C, 0xE0, 0xE5, 0x94, 0xFA, 0xFD, 0x2E, 0xD9, 0xEB, 0x8D, 
	0x5A, 0xC2, 0xEF, 0x39, 0x51, 0x71, 0x92, 0xFA, 0xDB, 0xEF, 0x14, 0x88, 0x00, 0xFF, 0xE3, 0xF6, 
	0xB5, 0x34, 0x34, 0x40, 0xF5, 0xBB, 0xC8, 0xD3, 0xB5, 0xBD, 0xF6, 0xCF, 0xC7, 0xB1, 0xF9, 0x18, 
	0x3D, 0xA2, 0x74, 0xEF, 0x40, 0xBC, 0x6B, 0x39, 0xF2, 0xC8, 0x6E, 0x00, 0x64, 0x78, 0x52, 0x88, 
	0x13, 0xF4, 0x27, 0x74, 0x14, 0x8F, 0xCE, 0x34, 0x5E, 0xF9, 0xE0, 0x6D, 0x47, 0xFC, 0x38, 0x6D, 
	0xB0, 0x03, 0xED, 0x6C, 0xF6, 0x68, 0x00, 0xAC, 0x2B, 0xFE, 0x73, 0x2C, 0x94, 0x9E, 0x3F, 0x17, 
	0x0C, 0x33, 0xB9, 0x8F, 0x33, 0x34, 0xDE, 0x05, 0x18, 0xE1, 0x2B, 0xB9, 0x42, 0x3F, 0x5F, 0xA2, 
	0xB4, 0x1E, 0xE9, 0x45, 0xF3, 0x38, 0x43, 0xBB, 0x8E, 0xB0, 0x0A, 0x94, 0x39, 0xEE, 0xFF, 0x9A, 
	0xF4, 0x2D, 0x6C, 0x4B, 0x66, 0xB1, 0x1E, 0x0F, 0xC2, 0x18, 0x32, 0xE1, 0x74, 0xFF, 0x90, 0x94, 
	0xF2, 0x38, 0xDD, 0x56, 0xDC, 0x78, 0x91, 0x96, 0xD1, 0x04, 0x03, 0x09, 0x21, 0x39, 0xB2, 0xD4, 
	0xCC, 0x2A, 0xA8, 0xAB, 0xE8, 0x99, 0x1C, 0xE7, 0xE4, 0x43, 0x3B, 0x58, 0xC1, 0x59, 0x54, 0xE8, 
	0xBD, 0x9C, 0x28, 0xC6, 0x81, 0xFC, 0xAD, 0x33, 0x4F, 0x24, 0x16, 0xA0, 0x47, 0xD1, 0x4C, 0x4D, 
	0x39, 0x7A, 0xC1, 0xF7, 0x1D, 0x04, 0xCF, 0xE7, 0xAE, 0x17, 0x71, 0xD9, 0x37, 0xDC, 0x9C, 0x0A, 
	0x0E, 0x9D, 0x0E, 0x04, 0xD7, 0x24, 0xC1, 0x50, 0x0C, 0x49, 0xE3, 0xBC, 0xCA, 0x98, 0x89, 0x55, 
	0x86, 0x73, 0xF1, 0xC3, 0x8D, 0x8F, 0x99, 0x34, 0xF7, 0x4B, 0xE7, 0x69, 0x0A, 0xB0, 0xC1, 0x2F, 
	0x85, 0x97, 0xBF, 0xC3, 0xFD, 0xD0, 0x62, 0x75, 0xB1, 0xAD, 0xF3, 0x04, 0xF3, 0xF3, 0x77, 0x06, 
	0xAA, 0x77, 0x5A, 0xE7, 0xEB, 0x67, 0x3F, 0xB5, 0x40, 0xA1, 0x9C, 0x53, 0x96, 0xFD, 0x85, 0x53, 
	0x6E, 0xED, 0x52, 0x05, 0x3B, 0x6E, 0x89, 0xEF, 0x95, 0x98, 0xB6, 0x66, 0x34, 0xD0, 0x8A, 0x3F, 
	0x44, 0xEA, 0x06, 0x86, 0x13, 0x39, 0xEF, 0x20, 0xAD, 0xE4, 0x73, 0x2C, 0x61, 0x77, 0x10, 0x3D, 
	0xB9, 0x0B, 0xC2, 0x0C, 0xFD, 0xF2, 0x99, 0xD8, 0xB1, 0x57, 0x83, 0x1B, 0x24, 0xA6, 0xA0, 0xAB, 
	0x97, 0x3E, 0xE5, 0x09, 0x07, 0x3F, 0x43, 0xED, 0x12, 0xE3, 0x36, 0xCE, 0x16, 0x58, 0xF2, 0x78, 
	0x00, 0x63, 0xF7, 0x67, 0xDC, 0xD9, 0x5F, 0x0D, 0xAA, 0x3E, 0x9A, 0xA3, 0x83, 0x72, 0xFE, 0xBA, 
	0x92, 0xE9, 0xD4, 0x22, 0xF0, 0x38, 0x38, 0x61, 0xE2, 0x79, 0x9B, 0x5E, 0x8A, 0x62, 0x27, 0x59, 
	0x84, 0x71, 0xC0, 0xEB, 0x95, 0x28, 0x0D, 0x34, 0xCB, 0xAB, 0x25, 0xC6, 0x3B, 0xBC, 0x52, 0xA5, 
	0xCA, 0x6B, 0x93, 0xCA, 0x23, 0x6D, 0x35, 0x87, 0x41, 0x87, 0x3E, 0x48, 0xB9, 0xDF, 0x0E, 0xFD, 
	0x30, 0xB8, 0xD1, 0xB8, 0x10, 0x68, 0x3D, 0xBC, 0x09, 0x04, 0x31, 0x94, 0x5C, 0x91, 0xAF, 0x6C
};

//uint32_t* g_xortab[] = { g_xortab0, g_xortab1 };

uint32_t g_xormagic = 0xFFFFFFFF;
uint32_t g_method = 0;
//int gs_chunksize = 0;

static char *gs_nfin, *gs_nfout;
static BFdesc *gs_fin = NULL, *gs_fout = NULL;

int ProcessZLFH(char *buf)
{
	int i, siz, cnt, rd, xoroff, ret = -1;
	char *off = buf + 4;

//	fputs("Local file header found.\n",stderr);

	READSHIFT(gs_fin,off,sizeof(ZLFH)-4);

	if (((ZLFH*)buf)->flags & (1<<2)) {
		fputs("Zip data descriptor not supported.\n",stderr);
		EXCEPT;
	}
	if (((ZLFH*)buf)->flags & (1<<12)) {
		fputs("Zip central directory encryption not supported.\n",stderr);
		EXCEPT;
	}
	if (((ZLFH*)buf)->flags & (1<<5)) {
		fputs("Info: current in-zip file uses strong encryption.\n",stderr);
		EXCEPT;
	}

	READSHIFT(gs_fin,off,((struct _ZLFH *)buf)->namelen);
	READSHIFT(gs_fin,off,((struct _ZLFH *)buf)->extralen);

//#if 0
	*(uint32_t*)buf ^= 0xFFFFFFFF;
//	bfwrite(gs_fout, buf, sizeof(ZLFH) + ((struct _ZLFH *)buf)->namelen + ((struct _ZLFH *)buf)->extralen);
//	FLUSH(gs_fout,buf,(int)(off - buf));

	cnt = ((ZLFH*)buf)->csize;
	siz = MIN(32, cnt);
	if(bfread(gs_fin,off,siz) != siz) EXCEPT;

	switch(g_method) {
		case 0: //current
			xoroff = cnt & 0x3FF;
			for(i=0;i<((siz+3)&(-4));i+=4) { //mangle / demangle
//			for(i=0;i<siz;i++) { //mangle / demangle
				*(uint32_t*)(off+i) ^= *(uint32_t*)(g_xortab0+xoroff+i);
//				*(off+i) ^= g_xortab0[xoroff+i];
//g_xortab0[xoroff+i];
			}
			break;
		case 1: //earlier
			xoroff = (cnt & 0x1F)<<3;
			for(i=0; i<(siz+3)>>2; i++) { //mangle / demangle - this is safe even if siz<32
//			for(i=0; i<8; i++) { //mangle / demangle - this is safe even if siz<32
//				printf("%X xor %X\n", *((uint32_t*)off+i) ,g_xortab1[xoroff+i]);
				*((uint32_t*)off+i) ^= g_xortab1[xoroff+i];
			}
	}

//	FLUSH(gs_fout,off,siz);

	off += siz;
	cnt -= siz;
	FLUSH(gs_fout,buf,(int)(off - buf));

//#endif
//	cnt = ((ZLFH*)buf)->csize;
	while(cnt > 0) {
		siz = MIN(CHUNK,cnt);
		if((rd = bfread(gs_fin, buf, siz)) != siz)
			EXCEPT;
		if(bfwrite(gs_fout, buf, rd) != rd)
			EXCEPT;
		cnt -= rd;
	}

	ret = 0;
EXCEPT_LABEL
	return ret;
}

int ProcessZCD_FH(char *buf)
{
	int ret = -1;
	char *off = buf + 4;

//	fputs("Central directory file header found.\n",stderr);
	*(uint32_t*)buf ^= 0xFFFFFFFF;
	READSHIFT(gs_fin,off,sizeof(ZCD_FH)-4);
	READSHIFT(gs_fin,off,((ZCD_FH*)buf)->namelen);
	READSHIFT(gs_fin,off,((ZCD_FH*)buf)->extralen);
	READSHIFT(gs_fin,off,((ZCD_FH*)buf)->commlen);

	FLUSH(gs_fout,buf,(int)(off - buf));

	ret = 0;
EXCEPT_LABEL
	return ret;
}

int ProcessZEOCD(char *buf)
{
	int ret = -1;
	char *off = buf + 4;

//	fputs("End of central directory found.\n",stderr);
	*(uint32_t*)buf ^= 0xFFFFFFFF;
	READSHIFT(gs_fin,off,sizeof(ZEOCD)-4);
	READSHIFT(gs_fin,off,((ZEOCD*)buf)->commlen);

	FLUSH(gs_fout,buf,(int)(off - buf));

	ret = 0;
EXCEPT_LABEL
	return ret;
}

static int ProcessZIP(void)
{
	int ret = -1, h;
	POOLER *pool;
	char *buf;

	if(!(pool = PoolerInit("Dynamic")))
		EXCEPT;
	if(!(buf = PoolerAssign(pool, CHUNK)))
		EXCEPT;

        while(1) {
		h = bfread(gs_fin,buf,4);
		if(!h)
			break;
		if(h != 4) {
			fputs("Zip/pak file too short.\n",stderr);
			EXCEPT;
		}
		switch(g_xormagic ^ *(uint32_t*)buf ) {
			case (ZLFH_magic):
				if(ProcessZLFH(buf)<0)
					EXCEPT;
				break;
			case (ZCD_FH_magic):
				if(ProcessZCD_FH(buf)<0)
					EXCEPT;
				break;

			case (ZEOCD_magic):
				if(ProcessZEOCD(buf)<0)
					EXCEPT;
				break;

			case (ZDD_magic):
			case (ZEDR_magic):
			case (ZCD_DS_magic):
			case (Z64EOCD_magic):
			case (Z64EOCDL_magic):
				fputs("Known magic, but unsupported.\n",stderr);
				EXCEPT;
			default:
				fputs("Zip/pak file invalid or unknown magic.\n",stderr);
				EXCEPT;
		}
        }

	ret = 0;
EXCEPT_LABEL
	PoolerDestroy(pool);

	return ret;
}

void Help(void)
{
        puts("AIONencdec <options> <source file> <destination file>\n");
        puts("Options:\n");
        puts("    -d        decrypt (assumed default)");
        puts("    -e        encrypt");
        puts("    -m <met>  choose \"method\"");
        puts("                0 - for current versions (assumed default)");
        puts("                1 - for earlier versions");
//        puts("    -b        bf chunk size (default 16777216 bytes)");
        puts("    -h        this help");
}

int Parse(int argc, char **argv)
{
	int c;
	opterr = 0;

	while ((c = getopt (argc, argv, ":hdem:")) != -1) {
		switch(c) {
			case 'd':
				g_xormagic = 0xFFFFFFFF;
				break;
			case 'e':
				g_xormagic = 0u;
				break;
			case 'm':
				g_method = (uint32_t)(*optarg) - '0';
				break;
			case 'h':
				Help();
				return -1;
			case '?':
				puts("Unknown option.\n");
				Help();
				return -1;
			case ':':
				puts("Missing required argument.\n");
				Help();
				return -1;
			default:
				puts("Getopt failure ? WTF !\n");
				return -255;
		}
	}
	if(optind+1 < argc) {
		gs_nfin = argv[optind];
		gs_nfout = argv[optind+1];
		if(!strcmp(gs_nfin, gs_nfout)) {
			puts("Input and output file name can't be the same.\n");
			return -1;
		}
	} else {
		puts("Missing output and/or input filename.\n");
		Help();
		return -1;
	}	
        return 0;
}

int main(int argc, char **argv)
{
	int ret = -1;

	puts("\nAIONencdec "DATT_VERSION" by "DATT_AUTHOR".\n");
	if(Parse(argc, argv)<0)
		EXCEPT;

	if(!(gs_fin = bfopen(r, gs_nfin, 0))) {
		fputs("main: Cannot open input file.\n",stderr);
		EXCEPT;
	}
	if(!(gs_fout = bfopen(w, gs_nfout, 0))) {
		fputs("main: Cannot open output file.\n",stderr);
		EXCEPT;
	}
	if(ProcessZIP()) {
		fputs("main: ProcessZIP failed.\n",stderr);
		EXCEPT;
	};

	ret = 0;

EXCEPT_LABEL
	if(gs_fin)
		bfclose(gs_fin);
	if(gs_fout)
		bfclose(gs_fout);

	return ret;
}
